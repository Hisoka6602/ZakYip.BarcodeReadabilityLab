# 健康检查与仿真模式使用指南

## 健康检查端点

本项目提供了三个健康检查端点，用于监控服务状态：

### 1. `/health` - 综合健康检查

返回所有健康检查项的状态，包括：
- **配置检查（configuration）**: 验证关键目录和配置项
- **数据库检查（database）**: 验证数据库连接
- **模型检查（model）**: 验证ML模型文件可用性

**示例响应：**
```json
{
  "status": "Healthy",
  "checks": [
    {
      "name": "configuration",
      "status": "Healthy",
      "description": "配置检查通过",
      "data": {
        "isConfigValid": true,
        "checkedItems": 4,
        "allPassed": true
      }
    },
    {
      "name": "database",
      "status": "Healthy",
      "description": "数据库连接正常",
      "data": {
        "isDatabaseOk": true
      }
    },
    {
      "name": "model",
      "status": "Degraded",
      "description": "模型文件不存在",
      "data": {
        "isModelAvailable": false,
        "reason": "模型文件不存在"
      }
    }
  ],
  "totalDuration": 45.2
}
```

### 2. `/ready` - 就绪检查

检查服务是否准备好处理请求。只检查标记为 "ready" 的健康检查项（配置、数据库、模型）。

**适用场景：**
- Kubernetes readiness probe
- 负载均衡器健康检查
- 部署验证

### 3. `/live` - 存活检查

轻量级存活检查，仅验证进程是否存活。

**示例响应：**
```json
{
  "status": "Healthy",
  "timestamp": "2025-11-21T12:00:00Z"
}
```

**适用场景：**
- Kubernetes liveness probe
- 进程监控
- 自动重启触发

---

## 仿真模式

仿真模式允许在没有实际训练数据的情况下快速启动和测试训练流程。

### 启用仿真模式

在 `appsettings.Development.json` 中配置：

```json
{
  "BarcodeAnalyzerOptions": {
    "WatchDirectory": "/tmp/BarcodeImages/Monitor",
    "UnresolvedDirectory": "/tmp/BarcodeImages/UnableToAnalyze",
    "IsSimulationMode": true,
    "ShouldAutoCreateDirectories": true
  },
  "TrainingOptions": {
    "TrainingRootDirectory": "/tmp/BarcodeImages/TrainingData",
    "OutputModelDirectory": "/tmp/BarcodeImages/Models",
    "IsSimulationMode": true,
    "ShouldAutoCreateDirectories": true
  }
}
```

### 仿真模式特性

1. **自动数据生成**：启动时自动生成示例训练数据
   - 3个类别：Normal（正常）、Blurry（模糊）、LowLight（光照不足）
   - 每个类别5个样本
   - 存储在临时目录

2. **自动目录创建**：如果配置的目录不存在，自动创建

3. **降级运行**：即使配置检查失败，服务仍可启动并以降级模式运行

### 仿真数据位置

仿真数据默认存储在：
- Windows: `%TEMP%\BarcodeReadabilityLab_Simulation\TrainingData`
- Linux/macOS: `/tmp/BarcodeReadabilityLab_Simulation/TrainingData`

### 清理仿真数据

仿真数据存储在临时目录，可以安全删除：

```bash
# Linux/macOS
rm -rf /tmp/BarcodeReadabilityLab_Simulation

# Windows PowerShell
Remove-Item -Path "$env:TEMP\BarcodeReadabilityLab_Simulation" -Recurse -Force
```

---

## 配置自检

服务启动时会自动执行配置自检，检查以下项目：

1. **监控目录**：WatchDirectory 是否存在
2. **未解决图片目录**：UnresolvedDirectory 是否存在
3. **训练数据目录**：TrainingRootDirectory 是否存在
4. **模型输出目录**：OutputModelDirectory 是否存在
5. **数据库连接**：数据库是否可连接

### 自检行为

- ✅ **检查通过**：目录存在或已成功创建
- ⚠️ **已自动修复**：目录不存在但已自动创建（需要配置 `ShouldAutoCreateDirectories: true`）
- ❌ **检查失败**：目录不存在且创建失败

### 查看自检结果

自检结果会输出到日志，并可通过 `/health` 端点查询：

```bash
curl http://localhost:4000/health
```

---

## 使用示例

### 在本地开发环境测试

1. **启用仿真模式**：
   ```bash
   # 编辑 appsettings.Development.json
   # 设置 IsSimulationMode: true
   ```

2. **启动服务**：
   ```bash
   cd src/ZakYip.BarcodeReadabilityLab.Service
   dotnet run
   ```

3. **检查健康状态**：
   ```bash
   curl http://localhost:4000/health
   curl http://localhost:4000/ready
   curl http://localhost:4000/live
   ```

4. **查看仿真数据**：
   ```bash
   # Linux/macOS
   ls -la /tmp/BarcodeReadabilityLab_Simulation/TrainingData
   
   # Windows PowerShell
   Get-ChildItem "$env:TEMP\BarcodeReadabilityLab_Simulation\TrainingData"
   ```

### 在 Kubernetes 中使用

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: barcode-lab
spec:
  containers:
  - name: service
    image: barcode-lab:latest
    livenessProbe:
      httpGet:
        path: /live
        port: 4000
      initialDelaySeconds: 10
      periodSeconds: 10
    readinessProbe:
      httpGet:
        path: /ready
        port: 4000
      initialDelaySeconds: 15
      periodSeconds: 5
```

---

## 故障排查

### 服务启动失败

1. **检查日志**：查看启动时的自检日志
2. **验证配置**：确认 `appsettings.json` 中的路径正确
3. **手动创建目录**：如果自动创建失败，手动创建所需目录
4. **启用仿真模式**：用于快速验证服务功能

### 健康检查失败

1. **查看详细状态**：
   ```bash
   curl http://localhost:4000/health | jq
   ```

2. **检查具体失败项**：根据响应中的 `checks` 数组定位问题

3. **常见问题**：
   - **配置检查失败**：目录不存在或权限不足
   - **数据库检查失败**：数据库文件损坏或权限不足
   - **模型检查失败**：模型文件不存在（可通过训练生成）

---

## 最佳实践

1. **生产环境**：
   - 禁用仿真模式（`IsSimulationMode: false`）
   - 使用真实的训练数据和模型
   - 配置持久化存储路径

2. **开发环境**：
   - 启用仿真模式快速开发
   - 启用自动目录创建
   - 使用临时目录存储数据

3. **CI/CD**：
   - 使用健康检查端点验证部署
   - 在集成测试中使用仿真模式
   - 自动清理临时数据

4. **监控**：
   - 定期查询 `/health` 端点
   - 配置告警规则
   - 记录健康检查历史

---

## 相关文档

- [快速开始](../QUICKSTART.md)
- [项目架构](../ARCHITECTURE.md)
- [训练服务](./训练服务.md)
- [部署指南](../DEPLOYMENT.md)
